#!/bin/sh

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

# easy-rsa parameter settings
export EASY_RSA="{{ openvpn_etcdir }}/easy-rsa"

# This variable should point to
# the requested executables
export PKCS11TOOL="pkcs11-tool"
export GREP="grep"


# This variable should point to
# the openssl.cnf file included
# with easy-rsa.
export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`

# Edit this variable to point to
# your soon-to-be-created key
# directory.
#
# WARNING: clean-all will do
# a rm -rf on this directory
# so make sure you define
# it correctly!
export KEY_DIR="{{ openvpn_keydir }}"

# Increase this to 2048 if you
# are paranoid.  This will slow
# down TLS negotiation performance
# as well as the one-time DH parms
# generation process.
export KEY_SIZE={{ openvpn_key_size }}

# In how many days should the root CA key expire?
export CA_EXPIRE=3650

# In how many days should certificates expire?
export KEY_EXPIRE=3650

# These are the default values for fields
# which will be placed in the certificate.
# Don't leave any of these fields blank.
export KEY_COUNTRY="{{ openvpn_key_country }}"
export KEY_PROVINCE="{{ openvpn_key_province }}"
export KEY_CITY="{{ openvpn_key_city }}"
export KEY_ORG="{{ openvpn_key_org }}"
export KEY_EMAIL="{{ openvpn_key_email }}"

# Prepare keys directory
[ -d "$KEY_DIR" ] || {

    mkdir "$KEY_DIR" && \
    chmod go-rwx "$KEY_DIR" && \
    touch "$KEY_DIR/index.txt" && \
    echo 01 >"$KEY_DIR/serial"

}

$EASY_RSA/pkitool --initca && \
$EASY_RSA/pkitool --server server && \
openssl dhparam -out ${KEY_DIR}/dh${KEY_SIZE}.pem ${KEY_SIZE}

{% for client in openvpn_clients %}
$EASY_RSA/pkitool {{ client }}
{% endfor %}
